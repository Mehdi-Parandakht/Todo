<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ú†Ú© Ù„ÛŒØ³Øª Ú©Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Persian Date & Datepicker -->
  <link href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" rel="stylesheet"/>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

  <style>
    body {
      font-family: Vazir Medium;
      background-color: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      padding-top: 30px;
    }

    :root {
      --bg: #f8f9fa;
      --text: #212529;
      --card: #ffffff;
    }

    body.dark {
      --bg: #1e1e2f;
      --text: #f8f9fa;
      --card: #2b2b3d;
    }

    .todo-card {
      background: var(--card);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .done {
      text-decoration: line-through;
      color: gray;
    }

    .toggle-theme {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #0d6efd;
      color: white;
      border: none;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      font-size: 22px;
    }
  </style>
</head>
<body class="container">

  <button id="themeBtn" class="toggle-theme">ğŸŒ™</button>

  <h2 class="text-center mb-4">ğŸ“… Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ø±ÙˆØ²Ø§Ù†Ù‡</h2>

  <div class="todo-card">
    <div class="row g-2 align-items-center mb-3">
      <div class="col-md-3">
        <input type="text" id="taskDate" class="form-control" placeholder="ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†">
      </div>
      <div class="col-md-3">
        <input id="taskTime" type="time" class="form-control" placeholder="Ø³Ø§Ø¹Øª Ø§Ù†Ø¬Ø§Ù…">
      </div>
      <div class="col-md-4">
        <input id="taskInput" type="text" class="form-control" placeholder="Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯...">
      </div>
      <div class="col-md-2">
        <button id="addBtn" class="btn btn-success w-100">â• Ø§ÙØ²ÙˆØ¯Ù†</button>
      </div>
    </div>
  </div>

  <div id="taskList" class="todo-card"></div>

  <div class="text-center">
    <button id="clearBtn" class="btn btn-danger">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡â€ŒÛŒ Ú©Ø§Ø±Ù‡Ø§</button>
  </div>

  <script>
    // Ø¹Ù†Ø§ØµØ± Ø§ØµÙ„ÛŒ
    const taskInput = document.getElementById('taskInput');
    const taskTime = document.getElementById('taskTime');
    const addBtn = document.getElementById('addBtn');
    const clearBtn = document.getElementById('clearBtn');
    const taskList = document.getElementById('taskList');
    const themeBtn = document.getElementById('themeBtn');
    let todos = JSON.parse(localStorage.getItem('todos')) || [];

    // ØªÙ†Ø¸ÛŒÙ… ØªÙ…
    function toggleTheme(){
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
      themeBtn.textContent = document.body.classList.contains('dark') ? 'â˜€ï¸' : 'ğŸŒ™';
    }
    themeBtn.addEventListener('click', toggleTheme);
    if(localStorage.getItem('theme') === 'dark') toggleTheme();

    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ Ø¨Ø§ Persian Datepicker
    $(function() {
      $("#taskDate").persianDatepicker({
        format: 'YYYY/MM/DD',
        initialValue: true,
        observer: true,
        autoClose: true,
      });
    });

    // Ø±Ø³Ù… Ù„ÛŒØ³Øª
    function renderTasks(){
      taskList.innerHTML = '';
      if(todos.length === 0){
        taskList.innerHTML = '<p class="text-center text-muted">ğŸ‰ Ù‡ÛŒÚ† Ú©Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>';
        return;
      }
      todos.forEach((task, index)=>{
        const div = document.createElement('div');
        div.className = 'd-flex justify-content-between align-items-center border-bottom py-2';
        div.innerHTML = `
          <span class="${task.done ? 'done' : ''}">
            ğŸ“… ${task.date} | ğŸ•’ ${task.time || '--:--'} | ${task.text}
          </span>
          <div>
            <button class="btn btn-sm btn-success me-1" onclick="toggleDone(${index})">âœ“</button>
            <button class="btn btn-sm btn-danger" onclick="deleteTask(${index})">âœ—</button>
          </div>
        `;
        taskList.appendChild(div);
      });
      localStorage.setItem('todos', JSON.stringify(todos));
    }

    // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±
    function addTask(){
      const text = taskInput.value.trim();
      const date = $("#taskDate").val();
      const time = taskTime.value;
      if(!text || !date) return alert("Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ùˆ ØªØ§Ø±ÛŒØ® Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
      const task = { text, date, time, done:false };
      todos.push(task);
      taskInput.value = ''; taskTime.value = '';
      renderTasks();
      localStorage.setItem('todos', JSON.stringify(todos));
      requestNotificationPermission(task);
    }

    // Ø§ØªÙ…Ø§Ù… Ú©Ø§Ø±
    function toggleDone(i){
      todos[i].done = !todos[i].done;
      renderTasks();
    }

    // Ø­Ø°Ù Ú©Ø§Ø±
    function deleteTask(i){
      if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØŸ")){
        todos.splice(i,1);
        renderTasks();
      }
    }

    // Ù¾Ø§Ú©â€ŒÚ©Ø±Ø¯Ù† Ú©Ù„ Ù„ÛŒØ³Øª
    clearBtn.addEventListener('click', ()=>{
      if(confirm("Ù‡Ù…Ù‡ ØªØ³Ú©â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯ØŸ")){
        todos = [];
        renderTasks();
      }
    });

    // Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§
    function requestNotificationPermission(task=null){
      if('Notification' in window){
        Notification.requestPermission().then(perm=>{
          if(perm==='granted' && task && task.time){
            scheduleNotification(task);
          }
        });
      }
    }

    function scheduleNotification(task){
      const [hour, minute] = task.time.split(":");
      const [jy,jm,jd] = task.date.split("/").map(x=>parseInt(x));
      const g = persianDate.toGregorian(jy, jm, jd);
      const notifyTime = new Date(g.gy, g.gm-1, g.gd, hour, minute);
      const diff = notifyTime - new Date();
      if(diff>0){
        setTimeout(()=> new Notification(`â° ÛŒØ§Ø¯Ø¢ÙˆØ±: ${task.text}`), diff);
      }
    }

    addBtn.addEventListener('click', addTask);
    window.addEventListener('load', renderTasks);
  </script>
</body>
</html>